<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <title>工作清單</title>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .task-list {
        max-width: 400px;
        margin: 0 auto;
      }
      .task-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        padding: 5px;
        border: 1px solid #ccc;
        cursor: pointer;
        word-break: break-all;
      }
      .task-item.done {
        background-color: #c7f1b1;
      }
      .separator {
        border-top: 1px solid #ccc;
        margin: 10px 0;
        padding: 0;
        cursor: default;
      }
    </style>
  </head>
  <!-- 之後結構改為
  最上方是stick! head包含各種文字按鈕，懸停後會出現下拉選單，下拉選單懸停時也不會縮回: 
  新增: 下拉選單包含新增工作或分割線
  刪除: 按下後清單左邊出現X，可以刪除工作或分割線
  篩選: 下拉選單包含各種類別
  存檔: 提供json下載
  讀取: 打開檔案瀏覽器，並供使用者上傳json
  搜尋: 直接包含搜尋符號和搜尋框
  再來是上方底下空白
  再來是工作清單，清單左右有空白，內容置左，
  每個元素有類別標記框、修改按鈕、勾勾按鈕 -->
  <body>
    <h1>工作清單</h1>
    <div class="task-list">
      <div>
        <input type="text" id="task-input" placeholder="新增工作" />
        <select id="category">
          <option value="未分類">未分類</option>
          <option value="PJ24">PJ24</option>
          <option value="PJ25">PJ25</option>
          <option value="PJ26">PJ26</option>
          <option value="PJ27">PJ27</option>
          <option value="PJ28">PJ28</option>
          <option value="PJ29">PJ29</option>
        </select>
        <button id="add">新增</button>
      </div>
      <div>
        <select id="filter-category">
          <option value="all">所有類別</option>
          <option value="未分類">未分類</option>
          <option value="PJ24">PJ24</option>
          <option value="PJ25">PJ25</option>
          <option value="PJ26">PJ26</option>
          <option value="PJ27">PJ27</option>
          <option value="PJ28">PJ28</option>
          <option value="PJ29">PJ29</option>
        </select>
      </div>
      <div id="task-container">
        <!-- 工作項目將在這裡動態顯示 -->
      </div>
      <div>
        <button id="save">存檔</button>
        <input type="file" id="file-input" accept=".json" />
        <button id="clear">清空</button>
      </div>
    </div>

    <!-- jsDelivr :: Sortable :: Latest (https://www.jsdelivr.com/package/npm/sortablejs) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <!-- 要再加上jqready 另外還有document(因為是動態元素)偵測taskItem的按鈕偵測器
    並將toggleTask、deleteTask等等放入
    還要增加清空按鈕、新增按鈕偵測器(由於addtask大改，因此也得補上缺失邏輯) 
    再加上filter-category change偵測器，並且編寫它所需函數(要注意在有filter時，存檔的JSON是否會缺失)-->
    <script>
      const taskContainer = document.getElementById("task-container");

      // 須研究是否可直接用JQ物件輸入
      new Sortable(taskContainer, {
        animation: 150,
      });

      function readInput() {
        const taskText = $("#task-input").val();
        const isDone = "false";
        const category = $("#category").val();
        return { taskText, isDone, category };
      }

      $("#task-input").on("keyup", function (event) {
        if (event.key === "Enter") {
          const { taskText, isDone, category } = readInput();
          addTask(taskText, isDone, category);
        }
      });

      function addTask(taskText, isDone, category) {
        if (taskText === "--") {
          // 添加分隔线
          const separator = $("<hr>").addClass("separator");
          $("#taskContainer").append(separator);
          // 添加工作
        } else if (taskText !== "") {
          const taskItem = $("<div>")
            .addClass("task-item")
            .data("text", taskText)
            .data("done", isDone ? "true" : "false")
            .data("category", category);

          $("<div>")
            .addClass("task-content")
            .text(`${category}: ${taskText}`)
            .appendTo(taskItem);

          const buttonContainer = $("<div>").appendTo(taskItem);

          $("<button>")
            .addClass("task-toggle")
            .text(isDone ? "完成" : "未完成")
            .appendTo(buttonContainer);

          $("<button>")
            .addClass("task-delete")
            .text("刪除")
            .appendTo(buttonContainer);

          $("#taskContainer").append(taskItem);
        }
      }

      function clearTasks() {
        $("#task-container").empty();
      }

      // 之後改成輸入task，並將該button屬於哪個task的邏輯寫至事件偵測
      function toggleTask(button) {
        const taskItem = $(button).closest(".task-item");
        const isDone = taskItem.data("done") === "true";
        taskItem.data("done", isDone ? "false" : "true");
        button.text(isDone ? "未完成" : "完成");
      }

      function deleteTask(button) {
        const taskItem = $(button).closest(".task-item");
        taskItem.remove();
      }

      // 之後返回一個json 下載json的功能分離
      function domToJSON() {
        const tasks = $(".task-item")
          .map(function () {
            return {
              text: $(this).data("text"),
              category: $(this).data("category"),
              done: $(this).data("done") === "true",
            };
          })
          .get();

        const jsonData = JSON.stringify(tasks, null, 2);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = $("<a>")
          .attr({
            href: url,
            download: "tasks.json",
          })
          .appendTo("body");

        a[0].click();

        URL.revokeObjectURL(url);
        a.remove();
      }

      window.addEventListener("unload", function (event) {
        localStorage.setItem("tasks", JSON.stringify(tasks));
      });

      function jsonToDOM(json) {
        // 轉成物件
        const tasks = JSON.parse(json);

        // 清空任務容器
        clearTasks();

        // 遍歷 JSON 數據中的每個任務物件
        tasks.forEach((task) => {
          // 從任務物件獲取必要資訊
          const taskText = task.text;
          const isDone = task.done === "true"; // 將字串轉為布爾
          const category = task.category;

          // 調用 addTask 函數來在畫面增加任務項
          addTask(taskText, isDone, category);
        });
      }

      $("#file-input").on("change", function () {
        const file = this.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            jsonToDOM(e.target.result);
          } catch (error) {
            alert("錯誤：JSON 解析失敗。");
          }
        };

        // 清空文件输入元素的值，以便允许相同文件的變化
        $("#file-input").val("");

        // 開始讀取所選文件的内容
        reader.readAsText(file);
      });

      $(window).on("load", function () {
        const savedTasks = localStorage.getItem("tasks");

        if (savedTasks) jsonToDOM(savedTasks);
      });

      $(window).on("beforeunload", function (event) {
        if ($("#task-container .task-item").length > 0) {
          event.returnValue = "未保存的資料將會遺失，確定要離開頁面嗎？";
        }
      });
    </script>
  </body>
</html>
