<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <title>工作清單</title>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .task-list {
        max-width: 400px;
        margin: 0 auto;
      }
      .task-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        padding: 5px;
        border: 1px solid #ccc;
        cursor: pointer;
        word-break: break-all;
      }
    </style>
  </head>
  <!-- 之後UI改為
  最上方是stick head(即使滑動清單也會保持同個位置)包含各種外觀為文字的按鈕，
  懸停後會出現下拉選單，懸停在下拉選單時不會縮回，直到滑鼠移開: 
  新增: 下拉選單包含新增工作或分割線
  刪除: 按下後清單左邊出現X，可以刪除工作或分割線
  清空: 刪除所有工作
  篩選: 下拉選單包含各種類別
  存檔: 提供json下載
  讀取: 打開檔案瀏覽器，並供使用者上傳json
  搜尋: 直接包含搜尋符號和搜尋框(可以透過enter鍵觸發)
  刪除、清空、存檔、讀取都集中到下方row，用圖示代替
  清空前加上中間pop出警告(看要用gsap還是alert)先問一次
  taskItem類別用方框框住，置於左側，字體可以根據類別有不同顏色
  看要不要給個icon

  再來是上方底下空白以確保在滑到最上方時清單與Head有些距離

  再來是工作清單，清單左右有空白，內容置左，
  每個元素有類別標記框、修改按鈕(事件註冊記得用event delegation)、勾勾按鈕 

  最下方同樣留有空白
  -->
  <body>
    <h1>工作清單</h1>
    <div class="task-list">
      <div>
        <input type="text" id="task-input" placeholder="新增工作" />
        <select id="category">
          <option value="未分類">未分類</option>
          <option value="PJ24">PJ24</option>
          <option value="PJ25">PJ25</option>
          <option value="PJ26">PJ26</option>
          <option value="PJ27">PJ27</option>
          <option value="PJ28">PJ28</option>
          <option value="PJ29">PJ29</option>
        </select>
        <button id="add">新增</button>
      </div>
      <div>
        <select id="filter-category">
          <option value="all">所有類別</option>
          <option value="未分類">未分類</option>
          <option value="PJ24">PJ24</option>
          <option value="PJ25">PJ25</option>
          <option value="PJ26">PJ26</option>
          <option value="PJ27">PJ27</option>
          <option value="PJ28">PJ28</option>
          <option value="PJ29">PJ29</option>
        </select>
      </div>
      <div id="task-container">
        <!-- 工作項目將在這裡動態顯示 -->
      </div>
      <div>
        <button id="save">存檔</button>
        <input type="file" id="file-input" accept=".json" />
        <button id="clear">清空</button>
      </div>
    </div>

    <!-- jsDelivr :: Sortable :: Latest (https://www.jsdelivr.com/package/npm/sortablejs) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <!-- 分割線目前還無法刪除(沒有它的刪除按鈕) -->
    <script>
      function readInput() {
        const taskText = $("#task-input").val();
        const isDone = false;
        const category = $("#category").val();

        // 讀取完成後清空輸入
        $("#task-input").val("");

        return { taskText, isDone, category };
      }

      function addTask(taskText, isDone, category) {
        if (taskText === "--") {
          // 添加分隔线
          const separator = $("<hr>").addClass("separator");
          $("#task-container").append(separator);
          // 添加工作
        } else if (taskText !== "") {
          const taskItem = $("<div>")
            .addClass("task-item")
            .data("text", taskText)
            .data("done", isDone ? "true" : "false")
            .data("category", category);

          $("<div>")
            .addClass("task-content")
            .text(`${category}: ${taskText}`)
            .appendTo(taskItem);

          const buttonContainer = $("<div>").appendTo(taskItem);

          $("<button>")
            .addClass("task-toggle")
            .text(isDone ? "完成" : "未完成")
            .appendTo(buttonContainer);

          $("<button>")
            .addClass("task-delete")
            .text("刪除")
            .appendTo(buttonContainer);

          $("#task-container").append(taskItem);
        }
      }

      function clearTasks() {
        $("#task-container").empty();
      }

      function toggleTask(taskItem) {
        const button = taskItem.find(".task-toggle");
        const isDone = taskItem.data("done") === "true";
        taskItem.data("done", isDone ? "false" : "true");
        button.text(isDone ? "未完成" : "完成");
      }

      function deleteTask(taskItem) {
        taskItem.remove();
      }

      function filterTasks(category) {
        // 將 #task-container 的所有子元素 ($(".task-item")) 隱藏起來
        $("#task-container .task-item").hide();

        // 然後使用 forEach 遍歷並顯示
        $("#task-container .task-item").each(function () {
          const taskItem = $(this);
          if (category === "all" || taskItem.data("category") === category) {
            taskItem.show();
          }
        });
      }

      function domToJSON() {
        const tasks = $("#task-container")
          .children()
          .map(function () {
            if ($(this).is("hr")) {
              return { type: "separator" };
            }
            return {
              text: $(this).data("text"),
              category: $(this).data("category"),
              done: $(this).data("done") === "true",
            };
          })
          .get();

        const jsonData = JSON.stringify(tasks, null, 2);
        return jsonData;
      }

      function downloadJSON(jsonData) {
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = $("<a>")
          .attr({
            href: url,
            download: "tasks.json",
          })
          .appendTo("body");

        a[0].click();

        URL.revokeObjectURL(url);
        a.remove();
      }

      function jsonToDOM(json) {
        // 轉成物件
        const tasks = JSON.parse(json);

        // 清空任務容器
        clearTasks();

        // 遍歷 JSON 數據中的每個任務物件
        tasks.forEach((task) => {
          // 從任務物件獲取必要資訊
          const taskText = task.text || "--";
          const isDone = task.done;
          const category = task.category;

          // 調用 addTask 函數來在畫面增加任務項
          addTask(taskText, isDone, category);
        });
      }
    </script>
    <script>
      $(window).on("load", function () {
        const savedTasks = localStorage.getItem("tasks");

        if (savedTasks) jsonToDOM(savedTasks);
      });

      $(window).on("unload", function () {
        localStorage.setItem("tasks", domToJSON());
      });
    </script>
    <script>
      // 事件偵測註冊
      $(document).ready(function () {
        // 使清單可拖動
        new Sortable($("#task-container").get()[0], {
          animation: 150,
        });

        // 新增工作相關
        $("#add").on("click", function () {
          const { taskText, isDone, category } = readInput();
          addTask(taskText, isDone, category);
        });

        $("#task-input").on("keyup", function (e) {
          if (e.key === "Enter") {
            const { taskText, isDone, category } = readInput();
            addTask(taskText, isDone, category);
          }
        });

        // 刪除工作相關(動態)
        $(document).on("click", ".task-delete", function () {
          const taskItem = $(this).closest(".task-item");
          deleteTask(taskItem);
        });

        // 切換工作狀態相關(動態)
        $(document).on("click", ".task-toggle", function () {
          const taskItem = $(this).closest(".task-item");
          toggleTask(taskItem);
        });

        // 清空工作相關
        $("#clear").on("click", clearTasks);

        // 篩選工作相關
        $("#filter-category").change(function () {
          const category = $(this).val();
          filterTasks(category);
        });

        // 存檔工作相關
        $("#save").on("click", function () {
          const jsonData = domToJSON();
          downloadJSON(jsonData);
        });

        // 上傳工作相關
        $("#file-input").on("change", function () {
          const file = this.files[0];
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              jsonToDOM(e.target.result);
            } catch (error) {
              alert("錯誤：JSON 解析失敗。");
            }
          };

          // 清空文件输入元素的值，以便允许相同文件的變化
          $("#file-input").val("");

          // 開始讀取所選文件的内容
          reader.readAsText(file);
        });

        // 開啟/關閉頁面相關
        $(window).on("beforeunload", function (e) {
          if ($("#task-container .task-item").length > 0) {
            return "未保存的資料將會遺失，確定要離開頁面嗎？";
          }
        });
      });
    </script>
  </body>
</html>
