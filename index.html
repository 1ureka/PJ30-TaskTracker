<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <link rel="icon" type="image/png" href="icons/favicon.png" />
    <title>Task Tracker</title>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap"
      rel="stylesheet"
    />
    <!-- jsDelivr :: Sortable :: Latest (https://www.jsdelivr.com/package/npm/sortablejs) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/CustomEase.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: "Noto Sans TC", sans-serif;
        color: white;
        background-color: hsl(210, 15%, 7.5%);
        overflow-y: scroll;
        overflow-x: hidden;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      ::-webkit-scrollbar {
        width: 10px;
      }

      ::-webkit-scrollbar-track {
        opacity: 0;
      }

      ::-webkit-scrollbar-thumb {
        background: hsla(200, 0%, 50%, 0.5);
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: hsla(200, 0%, 50%, 1);
      }

      input,
      select,
      button,
      textarea {
        font-family: "Noto Sans TC", sans-serif;
        color: white;
      }

      input[type="text"],
      select,
      textarea {
        background-color: hsla(200, 0%, 10%, 0.5);
        border-radius: 10px;
        padding: 5px;
        border-width: 0;
        box-shadow: inset 0px 0px 12px rgba(0, 0, 0, 0.5);
        font-size: 20px;
      }

      button {
        background-color: hsla(200, 0%, 20%, 0.9);
        border-radius: 10px;
        border-width: 0;
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        padding: 5px;
        cursor: pointer;
        font-size: 20px;
      }

      .pop-up {
        opacity: 0;
        visibility: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        position: fixed;
        padding: 10px;
        background-color: #333;
        border-radius: 10px;
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        z-index: 5;
      }

      #header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsl(200, 0%, 15%);
        border-radius: 0 0 10px 10px;
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        z-index: 10;
      }

      #favicon {
        position: absolute;
        left: 20px;
        width: 80px;
        height: auto;
      }

      h1 {
        position: absolute;
        left: 110px;
        display: flex;
        justify-content: center;
        font-size: 36px;
      }

      #search-container {
        position: relative;
        display: flex;
      }

      #search {
        width: 40px;
        height: 40px;
        margin-right: 10px;
      }

      #search-input {
        width: 20em;
      }

      #search-clear {
        display: none;
        width: 40px;
        height: 40px;
        background-color: aliceblue;
        border-radius: 10px;
        cursor: pointer;
        margin-left: 10px;
      }

      #filter-container {
        position: absolute;
        right: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #filter-container label {
        margin-right: 10px;
      }

      #left-panel {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 240px;
        padding: 10px;
        padding-top: 130px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        background-color: hsla(200, 0%, 15%, 0.5);
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        z-index: 5;
      }

      #left-panel-top {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }

      #task-input {
        width: 100%;
        resize: vertical;
        min-height: 10em;
      }

      #category,
      #add {
        margin: 10px;
      }

      #left-panel-bottom {
        display: flex;
        width: 100%;
        flex-wrap: wrap;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      #delete-done {
        position: fixed;
        right: 25px;
        bottom: 25px;
        cursor: pointer;
        padding: 10px;
      }

      #file-input {
        display: none;
      }

      #cleared {
        display: flex;
        justify-content: space-around;
        align-items: center;
        width: 7em;
        flex-wrap: wrap;
        flex-direction: row;
        z-index: 99;
      }

      #task-container {
        position: absolute;
        width: auto;
        top: 100px;
        left: 260px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .separator {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        width: 100%;
        cursor: grab;
        position: relative;
        /* 來自hr */
        unicode-bidi: isolate;
        margin-block-start: 0.5em;
        margin-block-end: 0.5em;
        margin-inline-start: auto;
        margin-inline-end: auto;
        border-style: solid;
        border-width: 1px;
      }

      .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        min-width: 50%;
        max-width: fit-content;
        margin-top: 5px;
        margin-bottom: 5px;
        background-color: hsla(200, 0%, 15%, 0.5);
        border-radius: 10px;
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        cursor: grab;
      }

      .task-item > div {
        display: flex;
        flex-direction: row;
        justify-content: center;
      }

      .task-content {
        align-items: baseline;
      }

      .task-function-container {
        align-items: center;
      }

      .task-delete {
        position: absolute;
        left: -60px;
        width: 40px;
        height: 40px;
      }

      .separator > .task-delete {
        left: -61px;
      }

      .task-category {
        padding: 5px;
        margin-right: 10px;
        margin-left: 10px;
        border-radius: 10px;
        background-color: hsla(200, 0%, 15%, 0.5);
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        text-align: center;
        min-width: 3em;
      }

      .task-text {
        margin: 1em;
      }

      .task-copy-text {
        margin: 5px;
        width: 40px;
        height: 40px;
        cursor: pointer;
      }

      #copied {
        position: absolute;
      }

      .task-status-container {
        position: relative;
        width: 40px;
        height: 40px;
        margin: 5px;
        margin-right: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .task-status-display {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        box-shadow: 0px 0px 12px rgba(0, 0, 0, 1);
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        position: absolute;
        z-index: 2;
        pointer-events: none;
      }

      .task-status-options {
        width: 85%;
        height: 85%;
        border-radius: 10px;
        padding: 0;
        margin: 0;
        position: absolute;
        cursor: pointer;
        z-index: 1;
      }
    </style>
  </head>
  <!-- 之後UI改為
  taskItem的類別用方框框住，置於左側，字體可以根據類別有不同顏色
  左側面板下方按鈕懸停時，上方有lable跑出
  架構是btn-container > lable-container:div + btn:img
  lable-container:div (clip-path) > lable:lable
  雙擊可以編輯內文，記得編輯完成放回屬性
  下方四按鈕圖示可用GIF做動畫，比如懸停時垃圾桶打開再關閉、清空往四處飛再從中間出現球並分裂回來
  整理注釋
  當切換狀態時，該task背景的顏色會變化，但不是整個，而是從右側或左側會漸變一個相應的顏色

  每個元素有修改按鈕(事件註冊記得用event delegation)
  -->
  <body>
    <div id="header">
      <img id="favicon" src="icons/favicon.png" />
      <h1>Task Tracker</h1>
      <div id="search-container">
        <img src="icons/search.png" id="search" />
        <input type="text" id="search-input" placeholder="搜尋" />
        <div id="search-clear"></div>
      </div>
      <div id="filter-container">
        <label for="filter-category">篩選</label>
        <select id="filter-category">
          <option value="all">所有類別</option>
          <option value="未分類">未分類</option>
          <option value="PJ24">PJ24</option>
          <option value="PJ25">PJ25</option>
          <option value="PJ26">PJ26</option>
          <option value="PJ27">PJ27</option>
          <option value="PJ28">PJ28</option>
          <option value="PJ29">PJ29</option>
        </select>
      </div>
    </div>
    <div id="left-panel">
      <div id="left-panel-top">
        <textarea id="task-input" placeholder="新增工作"></textarea>
        <select id="category">
          <option value="未分類">未分類</option>
          <option value="PJ24">PJ24</option>
          <option value="PJ25">PJ25</option>
          <option value="PJ26">PJ26</option>
          <option value="PJ27">PJ27</option>
          <option value="PJ28">PJ28</option>
          <option value="PJ29">PJ29</option>
        </select>
        <button id="add">新增</button>
      </div>
      <div id="left-panel-bottom">
        <button id="delete">刪除</button>
        <button id="delete-done">完成</button>
        <button id="clear">清空</button>
        <button id="save">存檔</button>
        <button id="upload">上傳</button>
        <input type="file" id="file-input" accept=".json" />
      </div>
    </div>
    <div id="task-container">
      <!-- 工作項目將在這裡動態顯示 -->
    </div>
    <div class="pop-up" id="copied">已複製內文</div>
    <div class="pop-up" id="cleared">
      <p>確定要清空嗎</p>
      <button type="button" id="cleared-check">確定</button>
      <button type="button" id="cleared-cancel">取消</button>
    </div>

    <script>
      function readInput() {
        const taskText = $("#task-input").val();
        const status = "U";
        const category = $("#category").val();

        // 讀取完成後清空輸入
        $("#task-input").val("");

        return { taskText, status, category };
      }

      function addTask(taskText, status, category) {
        if (taskText === "--") {
          addSeparator();
        } else if (taskText !== "") {
          const taskItem = createTaskItem(taskText, status, category);
          $("#task-container").append(taskItem);
          taskItem.show(500);
        }
      }

      function addSeparator() {
        const separator = $("<div>").addClass("separator");

        separator.hide();
        separator.addDeleteButton();

        $("#task-container").append(separator);
        separator.show(500);
      }

      function createTaskItem(taskText, status, category) {
        const taskItem = $("<div>")
          .addClass("task-item")
          .data("text", taskText)
          .data("status", status)
          .data("category", category);

        taskItem.hide();

        taskItem
          .addDeleteButton()
          .addContent(taskText, category)
          .addTaskFunctions(status);

        return taskItem;
      }

      $.fn.addDeleteButton = function () {
        const btn = $("<button>")
          .addClass("task-delete")
          .text("X")
          .appendTo(this);
        gsap.set(btn, { autoAlpha: 0 });
        return this;
      };

      $.fn.addContent = function (taskText, category) {
        const contentContainer = $("<div>")
          .addClass("task-content")
          .appendTo(this);

        $("<div>")
          .addClass("task-category")
          .text(`${category}`)
          .appendTo(contentContainer);
        $("<p>")
          .addClass("task-text")
          .text(`${taskText}`)
          .appendTo(contentContainer);

        return this;
      };

      $.fn.addTaskFunctions = function (status) {
        const functionContainer = $("<div>")
          .addClass("task-function-container")
          .appendTo(this);

        $("<img>")
          .attr("src", "icons/copy.png")
          .addClass("task-copy-text")
          .appendTo(functionContainer);

        const statusContainer = $("<div>")
          .addClass("task-status-container")
          .appendTo(functionContainer);
        const colorMap = {
          U: "#bbb",
          S: "#92e9ff",
          O: "#8ce197",
          F: "#ea81af",
        };

        $("<div>")
          .addClass("task-status-display")
          .text(status)
          .css("background-color", colorMap[status])
          .appendTo(statusContainer);

        const statusOptions = $("<select>")
          .addClass("task-status-options")
          .appendTo(statusContainer);
        $("<option>").val("U").text("未完成").appendTo(statusOptions);
        $("<option>").val("S").text("跳過").appendTo(statusOptions);
        $("<option>").val("O").text("完成").appendTo(statusOptions);
        $("<option>").val("F").text("失敗").appendTo(statusOptions);

        return this;
      };

      function clearTasks() {
        return new Promise((resolve, reject) => {
          const callback = function () {
            $("#task-container").children().remove();
            setTimeout(() => {
              resolve();
            }, 100);
            console.log("clear container");
          };
          if ($("#task-container").children().length > 0) {
            $("#task-container").children().hide(500, callback);
          } else {
            console.log("skip clear");
            resolve();
          }
        });
      }

      async function copyTaskText(taskItem, mouseX, mouseY) {
        const textToCopy = taskItem.data("text");

        const scrollLeft = $(document).scrollLeft();
        const scrollTop = $(document).scrollTop();

        await navigator.clipboard.writeText(textToCopy);

        // top 和 left 分別表示游標相對於元素頂部和左側的偏移
        gsap.set("#copied", {
          top: mouseY + scrollTop,
          left: mouseX + scrollLeft,
        });

        gsap
          .timeline({ defaults: { ease: "set1", overwrite: "auto" } })
          .to("#copied", { ease: "power3.out", duration: 0.5, autoAlpha: 1 })
          .to("#copied", { delay: 0.5, duration: 1, autoAlpha: 0 });
      }

      function toggleTask(taskItem, value) {
        const statusDisplay = taskItem.find(".task-status-display");
        taskItem.data("status", value);

        const colorMap = {
          U: "#ccc",
          S: "#92e9ff",
          O: "#8ce197",
          F: "#ea81af",
        };

        statusDisplay.text(value);
        statusDisplay.css("background-color", colorMap[value]);
      }

      function deleteTask(taskItem) {
        taskItem.hide(500, () => taskItem.remove());
      }

      function searchTasks(text) {
        const options = { shouldSort: false, keys: ["text"] };

        list = JSON.parse(domToJSON());
        const fuse = new Fuse(list, options);
        const result = fuse.search(text);

        const searchResult = [];
        result.forEach((item) => {
          searchResult.push(JSON.stringify(item.item));
        });

        return searchResult;
      }

      function filterTasks(category, searchResult) {
        $("#task-container .task-item").each(function () {
          const taskItem = $(this);
          const task = JSON.stringify({
            text: taskItem.data("text"),
            category: taskItem.data("category"),
            status: taskItem.data("status"),
          });
          const isShow =
            (category === "all" && searchResult === "all") ||
            (taskItem.data("category") === category &&
              searchResult.includes(task)) ||
            (taskItem.data("category") === category &&
              searchResult === "all") ||
            (category === "all" && searchResult.includes(task));

          if (!isShow) {
            taskItem.hide(500);
          } else {
            taskItem.show(500);
          }
        });
      }

      function domToJSON() {
        const tasks = $("#task-container")
          .children()
          .map(function () {
            if ($(this).hasClass("separator")) {
              return { type: "separator" };
            } else if ($(this).hasClass("task-item")) {
              return {
                text: $(this).data("text"),
                category: $(this).data("category"),
                status: $(this).data("status"),
              };
            }
          })
          .get();

        const jsonData = JSON.stringify(tasks, null, 2);
        return jsonData;
      }

      function downloadJSON(jsonData) {
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = $("<a>")
          .attr({
            href: url,
            download: "tasks.json",
          })
          .appendTo("body");

        a[0].click();

        URL.revokeObjectURL(url);
        a.remove();
      }

      async function jsonToDOM(json) {
        // 轉成物件
        const tasks = JSON.parse(json);

        // 清空任務容器
        await clearTasks();

        // 遍歷 JSON 數據中的每個任務物件
        tasks.forEach((task) => {
          // 從任務物件獲取必要資訊
          const taskText = task.text || "--";
          const status = task.status;
          const category = task.category;

          // 調用 addTask 函數來在畫面增加任務項
          addTask(taskText, status, category);
        });
      }
    </script>
    <script>
      $(window).on("load", function () {
        const savedTasks = localStorage.getItem("tasks");

        if (savedTasks) jsonToDOM(savedTasks);
      });

      $(window).on("unload", function () {
        localStorage.setItem("tasks", domToJSON());
      });
    </script>
    <script>
      // 事件偵測註冊
      $(document).ready(function () {
        // 使清單可拖動
        new Sortable($("#task-container").get()[0], {
          animation: 150,
        });

        // 新增工作相關
        $("#add").on("click", function () {
          const { taskText, status, category } = readInput();
          addTask(taskText, status, category);
        });

        $("#task-input").on("keyup", function (e) {
          if (e.key === "Enter") {
            const { taskText, status, category } = readInput();
            addTask(taskText, status, category);
          }
        });

        // 刪除工作相關(動態)
        $(document).on("click", ".task-delete", function () {
          const taskItem = $(this).closest(".task-item");
          const separator = $(this).closest(".separator");

          if (taskItem.length > 0) {
            deleteTask(taskItem);
            console.log("刪除工作");
          } else if (separator.length > 0) {
            deleteTask(separator);
            console.log("刪除分割線");
          } else {
            console.log("找不到刪除物件");
          }
        });

        // 切換工作狀態相關(動態)
        $(document).on("change", ".task-status-options", function () {
          const taskItem = $(this).closest(".task-item");
          const value = $(this).val();
          toggleTask(taskItem, value);
        });

        // 複製內文(動態)
        $(document).on("click", ".task-copy-text", function (e) {
          const taskItem = $(this).closest(".task-item");
          copyTaskText(taskItem, e.clientX, e.clientY);
        });

        // 清空工作相關
        $("#cleared-check").on("click", clearTasks);

        // 搜尋/篩選功能相關
        $("#search-input").keyup(function () {
          const category = $("#filter-category").val();
          const text = $("#search-input").val();
          const searchResult = text ? searchTasks(text) : "all";
          if (text) {
            $("#search-clear").show(500);
          } else {
            $("#search-clear").hide(500);
          }
          filterTasks(category, searchResult);
        });

        $("#search-clear").click(function () {
          $("#search-input").val("");
          const category = $("#filter-category").val();
          const searchResult = "all";
          $("#search-clear").hide(500);
          filterTasks(category, searchResult);
        });

        $("#filter-category").change(function () {
          const category = $("#filter-category").val();
          const text = $("#search-input").val();
          const searchResult = text ? searchTasks(text) : "all";
          filterTasks(category, searchResult);
        });

        // 存檔工作相關
        $("#save").on("click", function () {
          const jsonData = domToJSON();
          downloadJSON(jsonData);
        });

        // 上傳工作相關
        $("#upload").on("click", function () {
          $("#file-input").click();
        });

        $("#file-input").on("change", function () {
          const file = this.files[0];
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              jsonToDOM(e.target.result);
            } catch (error) {
              alert("錯誤：JSON 解析失敗。");
            }
          };

          // 清空文件输入元素的值，以便允许相同文件的變化
          $("#file-input").val("");

          // 開始讀取所選文件的内容
          reader.readAsText(file);
        });

        // 開啟/關閉頁面相關
        $(window).on("beforeunload", function (e) {
          if ($("#task-container .task-item").length > 0) {
            return "未保存的資料將會遺失，確定要離開頁面嗎？";
          }
        });
      });
    </script>

    <script>
      gsap.registerPlugin(ScrollTrigger);

      gsap.registerPlugin(CustomEase);

      CustomEase.create("set1", "0.455, 0.03, 0.515, 0.955");

      $(document).ready(function () {
        // init
        gsap.set("#delete-done", { autoAlpha: 0 });

        //
        // 有關進出刪除狀態動畫
        let isDeleting = false;
        const enterDeleting = () => {
          isDeleting = true;
          gsap
            .timeline({
              defaults: { duration: 0.3, ease: "set1", overwrite: "auto" },
            })
            .to(".task-item, .separator", { left: 60 })
            .to(".task-delete", { autoAlpha: 1 }, "<0.1")
            .to("#delete-done", { autoAlpha: 1 }, "<");
        };
        const exitDeleting = () => {
          isDeleting = false;
          gsap
            .timeline({
              defaults: { duration: 0.3, ease: "set1", overwrite: "auto" },
            })
            .to("#delete-done", { autoAlpha: 0 })
            .to(".task-delete", { autoAlpha: 0 }, "<")
            .to(".task-item, .separator", { left: 0 }, "<0.1");
        };

        $("#delete").on("click", function () {
          if (isDeleting) {
            exitDeleting();
          } else {
            enterDeleting();
          }
        });

        $("#delete-done").on("click", function () {
          exitDeleting();
        });

        // 滑鼠右鍵
        $(document).on("contextmenu", function (e) {
          if (isDeleting) {
            e.preventDefault();
            exitDeleting();
          }
        });

        // 彈出清空確認視窗
        let isCheckClear = false;
        const enterCheckClear = gsap.to("#cleared", {
          paused: true,
          duration: 0.5,
          ease: "set1",
          autoAlpha: 1,
        });

        $("#clear").on("click", function () {
          isCheckClear = true;
          enterCheckClear.timeScale(2).play();
        });

        $("#cleared-cancel").on("click", function () {
          isCheckClear = false;
          enterCheckClear.timeScale(1).reverse();
        });

        $("#cleared-check").on("click", function () {
          isCheckClear = false;
          enterCheckClear.timeScale(1).reverse();
        });

        // 滑鼠右鍵
        $(document).on("contextmenu", function (e) {
          if (isCheckClear) {
            e.preventDefault();
            enterCheckClear.timeScale(1).reverse();
          }
        });
      });
    </script>
  </body>
</html>
